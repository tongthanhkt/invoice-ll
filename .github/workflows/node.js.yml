name: GitHub Actions Deployment

on:
  push:
    branches:
      - main

jobs:
  deployment:
    runs-on: ubuntu-latest
    environment: 
      name: PRODUCTION

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: 🛎 Triggered by ${{ github.actor }}
        run: echo "🚀 Deployment triggered by a ${{ github.event_name }} event."

      - name: 🔄 Checkout repository
        uses: actions/checkout@v3

      - name: 📂 List repo files
        run: ls -la

      - name: 📦 Install dependencies
        run: npm install --force

      - name: 🏗️ Build project
        run: npm run build

      - name: 🧹 Clean unnecessary files
        run: |
          rm -rf .git
          rm -rf .cache
          rm -rf node_modules

      - name: 📦 Archive entire project (excluding node_modules & .git)
        run: |
          tar --exclude='./node_modules' --exclude='./.git' -czf project.tar.gz .

      - name: 🔐 Set up SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "unnecessary"

      - name: 📤 Upload archive to server
        run: |
          scp -i ${{ secrets.SSH_KEY }} -o StrictHostKeyChecking=no project.tar.gz ubuntu@${{ vars.REMOTE_HOST }}:/tmp/project.tar.gz

      - name: 📥 Extract and install on server
        run: |
          ssh -i ${{ secrets.SSH_KEY }} -o StrictHostKeyChecking=no ubuntu@${{ vars.REMOTE_HOST }} << 'EOF'
            # Tạo thư mục project nếu chưa có
            mkdir -p ~/${{ vars.REMOTE_PATH }}
            cd ~/${{ vars.REMOTE_PATH }}

            # Xoá nội dung cũ (nếu cần)
            rm -rf ./*

            # Giải nén file
            tar -xzf /tmp/project.tar.gz -C ./

            # Cài production dependencies
            npm ci --omit=dev

            # Cài Chromium nếu có script
            if [ -f scripts/setup-chromium.js ]; then
              node scripts/setup-chromium.js
            fi

            echo "✅ Deployment completed successfully!"
          EOF
