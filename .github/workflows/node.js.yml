name: GitHub Actions Deployment

on:
  push:
    branches:
      - main

jobs:
  deployment:
    runs-on: ubuntu-latest
    environment: 
      name: PRODUCTION

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ğŸ› Triggered by ${{ github.actor }}
        run: echo "ğŸš€ Deployment triggered by a ${{ github.event_name }} event."

      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“‚ List repo files
        run: ls -la

      - name: ğŸ“¦ Install dependencies
        run: npm install --force

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ§¹ Clean unnecessary files
        run: |
          rm -rf .git
          rm -rf .cache
          rm -rf node_modules

      - name: ğŸ“¦ Archive entire project (excluding node_modules & .git)
        run: |
          tar --exclude='./node_modules' --exclude='./.git' -czf project.tar.gz .

      - name: ğŸ” Set up SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "unnecessary"

      - name: ğŸ“¤ Upload archive to server
        run: |
          scp -i ${{ secrets.SSH_KEY }} -o StrictHostKeyChecking=no project.tar.gz ubuntu@${{ vars.REMOTE_HOST }}:/tmp/project.tar.gz

      - name: ğŸ“¥ Extract and install on server
        run: |
          ssh -i ${{ secrets.SSH_KEY }} -o StrictHostKeyChecking=no ubuntu@${{ vars.REMOTE_HOST }} << 'EOF'
            # Táº¡o thÆ° má»¥c project náº¿u chÆ°a cÃ³
            mkdir -p ~/${{ vars.REMOTE_PATH }}
            cd ~/${{ vars.REMOTE_PATH }}

            # XoÃ¡ ná»™i dung cÅ© (náº¿u cáº§n)
            rm -rf ./*

            # Giáº£i nÃ©n file
            tar -xzf /tmp/project.tar.gz -C ./

            # CÃ i production dependencies
            npm ci --omit=dev

            # CÃ i Chromium náº¿u cÃ³ script
            if [ -f scripts/setup-chromium.js ]; then
              node scripts/setup-chromium.js
            fi

            echo "âœ… Deployment completed successfully!"
          EOF
